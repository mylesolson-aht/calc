<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wholesale Travel Program Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }
        .container-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .input-tile {
            position: relative;
            background-color: #f9f9f9;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .input-tile.active {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
        }
        .input-tile:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .input-tile input {
            background-color: transparent;
            border: none;
            outline: none;
            font-size: 1.5rem;
            font-weight: 700;
            width: 100%;
            text-align: center;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        .input-error {
            border-color: #ff3b30 !important;
            box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.2) !important;
        }
        .highlight-monthly {
            background-color: #f2faff;
            color: #007aff;
            font-weight: 600;
        }
        .highlight-interest {
            background-color: #f0fdf4;
            color: #28a745;
            font-weight: 600;
        }
        .aloha-brand-text {
            color: #006699;
        }
        .upgrade-offer-box {
            background-color: #e0f2f1;
            color: #004d40;
        }
        .clipboard-message {
            display: none;
        }

        /* Small styling for the slider/wheel controls */
        .slider-track { height: 6px; border-radius: 999px; background: #e5e7eb; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #007aff;
            border-radius: 999px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: pointer;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-8">

    <!-- Main Container -->
    <div class="bg-white p-6 sm:p-10 rounded-2xl container-shadow w-full max-w-lg mx-auto">

        <!-- Header -->
        <div class="flex flex-col items-center mb-8">
            <!-- Embedded SVG logo to avoid external missing JPEG issues -->
            <svg role="img" aria-label="Aloha Hawaii Tours & Travel Logo" class="w-32 sm:w-40 md:w-48 mb-2" viewBox="0 0 300 80" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                        <stop offset="0%" stop-color="#00a3cc" />
                        <stop offset="100%" stop-color="#006699" />
                    </linearGradient>
                </defs>
                <rect width="300" height="80" rx="12" fill="none" />
                <g transform="translate(12,12)">
                    <circle cx="28" cy="28" r="22" fill="url(#g1)" />
                    <path d="M20 28c5-8 20-8 25 0" stroke="#fff" stroke-width="3" fill="none" stroke-linecap="round" />
                    <text x="66" y="34" font-family="Inter, sans-serif" font-weight="700" font-size="20" fill="#006699">Aloha Hawaii</text>
                    <text x="66" y="54" font-family="Inter, sans-serif" font-weight="500" font-size="12" fill="#4b5563">Tours & Travel</text>
                </g>
            </svg>
            <h1 class="text-3xl sm:text-4xl font-bold text-center aloha-brand-text">Wholesale Travel Program</h1>
            <p class="text-center text-gray-500 mt-2">Eliminate the Retail Markup on Your Travel</p>
        </div>

        <!-- Input Fields Section - Now using tiles -->
        <div class="space-y-6 mb-8">
            <!-- Membership Tiles -->
            <div class="space-y-4">
                <p class="text-sm font-medium text-gray-700">Membership</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="planTilesContainer">
                    <!-- Tile for Legacy Unlimited -->
                    <div class="input-tile flex flex-col justify-center items-center active" data-plan="legacy">
                        <span class="text-xl sm:text-2xl font-bold">Legacy</span>
                        <span class="text-xs text-gray-500">Unlimited</span>
                    </div>
                    <!-- Tile for 10 Year Unlimited -->
                    <div class="input-tile flex flex-col justify-center items-center" data-plan="10year">
                        <span class="text-xl sm:text-2xl font-bold">10 Year</span>
                        <span class="text-xs text-gray-500">Unlimited</span>
                    </div>
                    <!-- Tile for Trial 3 Year -->
                    <div class="input-tile flex flex-col justify-center items-center" data-plan="3year">
                        <span class="text-xl sm:text-2xl font-bold">Trial</span>
                        <span class="text-xs text-gray-500">3 Year</span>
                    </div>
                </div>
            </div>

            <!-- Initial Amount Tile + Slider -->
            <div>
                <p class="text-sm font-medium text-gray-700">Initial Amount</p>
                <div class="input-tile flex flex-col justify-center items-center mt-1">
                    <!-- Number input -->
                    <input type="number" id="cashDown" step="50" class="text-gray-900" placeholder="0" min="0">
                    <!-- Range slider (cash down slider / "wheel") -->
                    <div class="w-full mt-4">
                        <input id="cashDownRange" type="range" min="0" max="5000" step="50" value="0" class="w-full slider-track">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span id="cashDownRangeMinLabel">$0</span>
                            <span id="cashDownRangeMaxLabel">$5,000+</span>
                        </div>
                    </div>
                </div>
                <p id="cashDownError" class="error-message hidden mt-2 text-xs text-red-500 text-center">Initial Amount must be at least 10% of the total Membership value.</p>
            </div>

            <!-- Amortization Period "Wheel" -->
            <div>
                <p class="text-sm font-medium text-gray-700">Amortization Period (months)</p>
                <div class="input-tile flex flex-col justify-center items-center mt-1">
                    <div class="w-full">
                        <!-- A range "wheel" to select available terms. Steps map to the terms array in JS -->
                        <input id="amortizationRange" type="range" min="0" max="5" step="1" value="3" class="w-full slider-track">
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                            <span>6</span>
                            <span>12</span>
                            <span>18</span>
                            <span>24</span>
                            <span>36</span>
                            <span>48</span>
                        </div>
                        <p id="selectedAmortization" class="mt-3 text-lg font-semibold">24 Months</p>
                    </div>
                </div>
            </div>

            <!-- Monthly Amount preview (moved above interest savings) -->
            <div id="monthlyPreviewDiv">
                <p class="text-sm font-medium text-gray-700">Monthly Amount</p>
                <div id="monthlyPreview" class="p-4 rounded-xl bg-gray-50 highlight-monthly mt-1 text-center">
                    <p id="monthlyPreviewAmount" class="text-xl sm:text-2xl font-bold text-gray-900">$0</p>
                    <p id="monthlyPreviewTerm" class="text-xs text-gray-500 mt-1">24 months</p>
                </div>
            </div>
            
            <!-- Your Interest Savings -->
            <div id="totalInterestSavedDiv">
                <p class="text-sm font-medium text-gray-700">Your Interest Savings</p>
                <div id="totalInterestSaved" class="p-4 rounded-xl bg-green-50 highlight-interest mt-1 text-center cursor-pointer transition-transform duration-200 transform hover:scale-105">
                    <p class="text-xl sm:text-3xl font-bold text-green-800">$0</p>
                </div>
            </div>
        </div>

        <!-- Calculated Results Section -->
        <div class="border-t border-gray-200 pt-8">
            <h2 class="text-xl sm:text-2xl font-semibold mb-6">Your Wholesale Travel Membership</h2>
            
            <div id="results" class="space-y-6">
                <!-- Key Numbers -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center sm:text-left">
                    <div class="p-4 rounded-xl bg-gray-50 flex flex-col justify-between">
                        <p class="text-sm font-medium text-gray-500">Membership Value</p>
                        <p id="principalAmount" class="text-2xl font-bold mt-1">$0</p>
                    </div>
                    <div class="p-4 rounded-xl bg-gray-50 flex flex-col justify-between">
                        <p class="text-sm font-medium text-gray-500">Initial Amount</p>
                        <p id="cashDownAmount" class="text-2xl font-bold mt-1">$0</p>
                    </div>
                    <div class="p-4 rounded-xl bg-gray-50 flex flex-col justify-between">
                        <p class="text-sm font-medium text-gray-500">Remaining Balance</p>
                        <p id="remainingBalanceAmount" class="text-2xl font-bold mt-1">$0</p>
                    </div>
                </div>

                <!-- Cash Options -->
                <div id="cashResults" class="hidden">
                    <h3 class="text-lg sm:text-xl font-semibold mb-4">Cash Price</h3>
                    <div class="p-4 rounded-xl bg-green-50 highlight-interest mb-4">
                        <p class="text-sm text-gray-700">Total Due</p>
                        <p id="cashOutTotal" class="text-3xl sm:text-4xl font-bold mt-1">$0</p>
                    </div>
                </div>
                
                <!-- Financing Options -->
                <div id="financingResults" class="hidden">
                    <h3 class="flex items-baseline justify-between text-lg sm:text-xl font-semibold mb-4">
                        Monthly Amount
                    </h3>
                    <div id="monthlyPayments" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Monthly payments will be inserted here by JavaScript -->
                    </div>

                    <!-- Daily Upgrade Offer -->
                    <div id="upgradeOfferContainer" class="mt-6">
                        <p class="text-sm font-medium text-gray-700">Upgrade Offer</p>
                        <div id="upgradeOffer" class="p-4 rounded-xl upgrade-offer-box mt-1 flex justify-center items-center cursor-pointer">
                            <p id="upgradeOfferText" class="text-lg font-semibold"></p>
                        </div>
                    </div>

                    <!-- Add a new container for the show/hide feature -->
                    <div id="totalInterestContainer" class="mt-6">
                        <div class="flex items-center mb-2">
                            <h3 class="text-sm font-medium text-gray-700">Financing Details</h3>
                            <!-- Button to toggle visibility -->
                            <button id="toggleInterestButton" aria-expanded="false" class="ml-2 text-xs font-semibold text-blue-500 hover:text-blue-700 focus:outline-none">
                                <span id="interestToggleIcon" aria-hidden="true"></span>
                            </button>
                        </div>
                        <div id="totalInterestPaid" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                            <!-- Total interest paid will be inserted here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Manage Options -->
            <div class="mt-8">
                <div class="flex items-center mb-2">
                    <label for="taCode" class="text-sm font-medium text-gray-700">Manage Options</label>
                     <button id="toggleTaCodeButton" aria-expanded="false" class="ml-2 text-xs font-semibold text-blue-500 hover:text-blue-700 focus:outline-none">
                        <span id="taToggleIcon" aria-hidden="true"></span>
                    </button>
                </div>
                <div id="taCodeSection" class="mt-1 hidden">
                    <select id="taCode" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm transition-colors">
                        <option value="no">No</option>
                        <option value="1">1 ($250) (Requires Manager Approval)</option>
                        <option value="2">2 ($500) (Requires Manager Approval)</option>
                    </select>
                    <p id="taCodeMessage" class="mt-2 text-xs text-gray-500 text-center"></p>
                </div>
            </div>
        </div>

        <!-- Legalese Footer -->
        <div class="mt-8 text-center text-xs text-gray-500 border-t border-gray-200 pt-4">
            <p>All calculations are for illustrative purposes only. This is not a binding quote. Actual terms, conditions, and pricing are subject to the specific membership agreement and credit application.</p>
        </div>
    </div>

    <!-- Confirmation Message -->
    <div id="clipboard-message" class="clipboard-message">
        Copied!
    </div>

    <script>
        // Get all input elements
        const planTilesContainer = document.getElementById('planTilesContainer');
        const taCodeInput = document.getElementById('taCode');
        const cashDownInput = document.getElementById('cashDown');
        const cashDownRange = document.getElementById('cashDownRange');
        const cashDownRangeMinLabel = document.getElementById('cashDownRangeMinLabel');
        const cashDownRangeMaxLabel = document.getElementById('cashDownRangeMaxLabel');

        // Amortization controls
        const amortizationRange = document.getElementById('amortizationRange');
        const selectedAmortizationLabel = document.getElementById('selectedAmortization');

        // Monthly preview elements
        const monthlyPreview = document.getElementById('monthlyPreview');
        const monthlyPreviewAmount = document.getElementById('monthlyPreviewAmount');
        const monthlyPreviewTerm = document.getElementById('monthlyPreviewTerm');

        // Get all output elements
        const principalAmountOutput = document.getElementById('principalAmount');
        const cashDownAmountOutput = document.getElementById('cashDownAmount');
        const remainingBalanceAmountOutput = document.getElementById('remainingBalanceAmount');
        const monthlyPaymentsContainer = document.getElementById('monthlyPayments');
        const totalInterestPaidContainer = document.getElementById('totalInterestPaid'); 
        const totalInterestSavedOutputDiv = document.getElementById('totalInterestSavedDiv');
        const totalInterestSavedOutput = document.getElementById('totalInterestSaved');
        const cashOutTotalOutput = document.getElementById('cashOutTotal');
        const financingResultsSection = document.getElementById('financingResults');
        const cashResultsSection = document.getElementById('cashResults');
        const cashDownError = document.getElementById('cashDownError');
        const resultsSection = document.getElementById('results');
        const upgradeOfferText = document.getElementById('upgradeOfferText');
        const upgradeOfferContainer = document.getElementById('upgradeOfferContainer');
        const upgradeOffer = document.getElementById('upgradeOffer');

        // New elements for show/hide functionality and clipboard
        const totalInterestContainer = document.getElementById('totalInterestContainer');
        const toggleInterestButton = document.getElementById('toggleInterestButton');
        const interestToggleIcon = document.getElementById('interestToggleIcon');
        const taCodeSection = document.getElementById('taCodeSection');
        const toggleTaCodeButton = document.getElementById('toggleTaCodeButton');
        const taToggleIcon = document.getElementById('taToggleIcon');
        const taCodeMessage = document.getElementById('taCodeMessage');

        // Constants
        const interestRate = 0.1799;
        // Added 36 and 48 month terms here
        const terms = [6, 12, 18, 24, 36, 48];
        const TA_CODES = {
            'no': 0,
            '1': 250,
            '2': 500,
        };
        const planPrices = {
            'legacy': 4499,
            '10year': 2499,
            '3year': 999,
        };
        const UPGRADE_PATHS = {
            '3year': {
                message: 'Travel 10 Years Unlimited for only',
                price: 2499,
                nextPlan: '10year'
            },
            '10year': {
                message: 'Never Pay Retail Again for only',
                price: 4499,
                nextPlan: 'legacy'
            }
        };

        // SVG icon strings for toggles
        const eyeSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-gray-500"><path d="M12 5c4.971 0 9.188 3.225 10.676 7.697a1.5 1.5 0 0 1 0 1.106C21.188 18.775 16.971 22 12 22S2.812 18.775 1.324 14.803a1.5 1.5 0 0 1 0-1.106C2.812 8.225 7.029 5 12 5zm0 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/></svg>`;
        const eyeOffSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-gray-500"><path d="M3.28 2.22a.75.75 0 0 0-1.06 1.06l2.06 2.06A19.06 19.06 0 0 0 1.32 11.7a1.5 1.5 0 0 0 0 1.1C2.81 17.02 7.03 20.25 12 20.25c1.9 0 3.71-.4 5.33-1.12l2.06 2.06a.75.75 0 1 0 1.06-1.06L4.34 2.22a.75.75 0 0 0-1.06 0zM9.88 11.06a3 3 0 0 0 3.06 3.06l-3.06-3.06z" /></svg>`;

        // Map amortizationRange values (0..5) to terms array.
        function amortizationIndexToMonths(index) {
            return terms[index] || 24;
        }

        // PMT (Payment) formula implementation
        function pmt(rate, nper, pv) {
            if (rate === 0) return pv / nper;
            const pvif = Math.pow(1 + rate, nper);
            return (rate * pv * pvif) / (pvif - 1);
        }
        
        // Helper function for currency formatting
        function formatCurrency(amount, fractionDigits = 0) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: fractionDigits,
                maximumFractionDigits: fractionDigits
            }).format(amount);
        }
        function formatCurrencyWithCents(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Toggle icon helpers
        function setInterestIcon(expanded) {
            interestToggleIcon.innerHTML = expanded ? eyeOffSVG : eyeSVG;
            toggleInterestButton.setAttribute('aria-expanded', expanded);
        }
        function setTaIcon(expanded) {
            taToggleIcon.innerHTML = expanded ? eyeOffSVG : eyeSVG;
            toggleTaCodeButton.setAttribute('aria-expanded', expanded);
        }

        // Main calculation function
        function calculate() {
            const activePlanTile = document.querySelector('.input-tile.active');
            const plan = activePlanTile ? activePlanTile.dataset.plan : null;
            const planPrice = planPrices[plan];
            let cashDown = parseFloat(cashDownInput.value) || 0;

            const taCode = taCodeInput.value;
            const principal = planPrice - TA_CODES[taCode];
            const minCashDownFinancing = Math.round(principal * 0.10);

            // Handle TA-Options based on new logic
            if (cashDown >= principal || cashDown >= minCashDownFinancing) {
               taCodeInput.disabled = false;
               taCodeMessage.textContent = 'TA-Options are always available regardless of down payment.';
            } else {
                taCodeInput.disabled = true;
                taCodeInput.value = 'no';
                taCodeMessage.textContent = 'Requires a down payment greater than 10% or a full cash payment.';
            }
            
            // Set min and max attributes for the input field to constrain arrow keys and slider
            cashDownInput.min = minCashDownFinancing;
            cashDownInput.max = principal;
            cashDownRange.min = 0;
            cashDownRange.max = principal;
            cashDownRange.step = 50;

            // Enforce minimum and maximum values for manual entry
            if (cashDown < minCashDownFinancing) {
                cashDownInput.classList.add('input-error');
                cashDownError.classList.remove('hidden');
            } else {
                cashDownInput.classList.remove('input-error');
                cashDownError.classList.add('hidden');
            }
            if (cashDown > principal) {
                cashDown = principal;
                cashDownInput.value = cashDown;
            }

            // Sync range with number input
            cashDownRange.value = cashDown;
            cashDownRangeMinLabel.textContent = formatCurrency(0);
            cashDownRangeMaxLabel.textContent = formatCurrency(principal);

            // Update main numbers
            principalAmountOutput.textContent = formatCurrency(principal);
            cashDownAmountOutput.textContent = formatCurrency(cashDown);

            // Selected amortization months (wheel)
            const amortIndex = parseInt(amortizationRange.value, 10);
            const amortMonths = amortizationIndexToMonths(amortIndex);
            selectedAmortizationLabel.textContent = `${amortMonths} Months`;

            // Always calculate and display interest savings first using the selected amortization period
            const minCashDown = Math.round(principal * 0.10);
            const baseRemainingBalance = principal - minCashDown;
            const monthlyRate = interestRate / 12;
            const baseMonthlyPayment = pmt(monthlyRate, amortMonths, baseRemainingBalance);
            const baseTotalInterest = (baseMonthlyPayment * amortMonths) - baseRemainingBalance;
            
            const currentRemainingBalance = principal - cashDown;
            let currentTotalInterest = 0;
            let currentMonthlyForSelected = 0;
            if (currentRemainingBalance > 0) {
                const currentMonthlyPayment = pmt(monthlyRate, amortMonths, currentRemainingBalance);
                currentTotalInterest = (currentMonthlyPayment * amortMonths) - currentRemainingBalance;
                currentMonthlyForSelected = currentMonthlyPayment;
            }
            
            const interestSaved = baseTotalInterest - currentTotalInterest;

            if (cashDown === minCashDown) {
                totalInterestSavedOutput.innerHTML = `<p class="text-xl sm:text-3xl font-bold text-green-800">Increase Initial Amount to Save Interest</p>`;
            } else {
                totalInterestSavedOutput.innerHTML = `<p class="text-xl sm:text-3xl font-bold text-green-800">${formatCurrency(interestSaved, 2)}</p>`;
            }

            // Update monthly preview (the small "Monthly Amount" moved above the interest savings)
            if (cashDown >= principal || currentRemainingBalance <= 0) {
                monthlyPreviewAmount.textContent = formatCurrency(0, 2);
                monthlyPreviewTerm.textContent = `${amortMonths} months`;
            } else {
                monthlyPreviewAmount.textContent = formatCurrency(currentMonthlyForSelected, 2);
                monthlyPreviewTerm.textContent = `${amortMonths} months`;
            }

            // Check for cash deal
            if (cashDown >= principal) {
                cashResultsSection.classList.remove('hidden');
                financingResultsSection.classList.add('hidden');
                upgradeOfferContainer.classList.add('hidden');
                remainingBalanceAmountOutput.textContent = formatCurrency(0);
                cashOutTotal.textContent = formatCurrency(cashDown);
            } else {
                cashResultsSection.classList.add('hidden');
                financingResultsSection.classList.remove('hidden');
                const remainingBalance = principal - cashDown;
                remainingBalanceAmountOutput.textContent = formatCurrency(remainingBalance);

                // Update monthly payments
                monthlyPaymentsContainer.innerHTML = '';
                totalInterestPaidContainer.innerHTML = '';

                terms.forEach(term => {
                    const monthlyPayment = pmt(monthlyRate, term, remainingBalance);
                    const isSelected = term === amortMonths;
                    
                    const monthlyDiv = document.createElement('div');
                    monthlyDiv.className = `p-4 rounded-xl shadow-sm flex flex-col justify-between ${isSelected ? 'highlight-monthly' : 'bg-gray-50'}`;
                    monthlyDiv.innerHTML = `
                        <p class="text-sm text-gray-500">${term} Months</p>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(monthlyPayment, 2)}</p>
                    `;
                    monthlyPaymentsContainer.appendChild(monthlyDiv);
                });
                
                // Calculate and display upgrade offer
                upgradeOfferText.textContent = ''; // Clear previous offers
                const upgradeInfo = UPGRADE_PATHS[plan];
                if (upgradeInfo) {
                    upgradeOfferContainer.classList.remove('hidden');
                    
                    // --- Upgrade Offer Calculation ---
                    // 1. Get the percentage of the current principal that the cash down payment represents.
                    const cashDownRatio = (principal > 0) ? (cashDown / principal) : 0;

                    // 2. Calculate the next principal amount after applying the TA-Code discount.
                    const nextPrincipal = upgradeInfo.price - TA_CODES[taCode];
                    
                    // 3. Apply the same cash down percentage to the next principal to find the next cash down amount.
                    const nextCashDown = nextPrincipal * cashDownRatio;
                    
                    // 4. Calculate the remaining balance for the upgraded plan.
                    const nextRemainingBalance = nextPrincipal - nextCashDown;
                    
                    // 5. Calculate the new monthly payment for the upgraded plan using selected amortization.
                    const nextMonthlyPayment = pmt(monthlyRate, amortMonths, nextRemainingBalance);

                    // 6. Calculate the current monthly payment (selected amortization).
                    const currentMonthlyPayment = pmt(monthlyRate, amortMonths, remainingBalance);
                    
                    // 7. Find the difference between the two monthly payments.
                    const monthlyDifference = nextMonthlyPayment - currentMonthlyPayment;
                    
                    // 8. Convert the monthly difference to a daily difference for the display text.
                    const dailyDifference = monthlyDifference / 30.44;

                    // Display the final calculation to the user.
                    upgradeOfferText.innerHTML = `${upgradeInfo.message} <span class="font-bold">${formatCurrencyWithCents(dailyDifference)}</span> <span class="text-xs">a day.</span>`;
                } else {
                    upgradeOfferContainer.classList.add('hidden');
                }

                // Update total interest paid
                terms.forEach(term => {
                    const monthlyPayment = pmt(monthlyRate, term, remainingBalance);
                    const totalInterest = (monthlyPayment * term) - remainingBalance;
                    const interestDiv = document.createElement('div');
                    interestDiv.className = `p-4 rounded-xl shadow-sm bg-gray-50 flex flex-col justify-end`;
                    interestDiv.innerHTML = `
                        <p class="text-sm text-gray-500">${term} Months</p>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(totalInterest, 2)}</p>
                        <p class="text-xs text-gray-500 mt-2">Total Interest Paid</p>
                    `;
                    totalInterestPaidContainer.appendChild(interestDiv);
                });
            }
        }

        // Function to handle changes to the plan selection
        function handlePlanChange(selectedTile) {
            // Remove active class from all tiles
            document.querySelectorAll('.input-tile').forEach(tile => tile.classList.remove('active'));
            // Add active class to the selected tile
            selectedTile.classList.add('active');

            const plan = selectedTile.dataset.plan;
            
            // Set initial cash down and check for TA options
            // Legacy default cash is to be $500 same as 10-year per request
            let defaultCashDown;
            if (plan === 'legacy' || plan === '10year') {
                defaultCashDown = 500;
            } else {
                defaultCashDown = Math.round(planPrices[plan] * 0.20);
            }
            cashDownInput.value = defaultCashDown;
            cashDownRange.value = defaultCashDown;
            
            resultsSection.classList.remove('hidden');

            calculate();
        }

        // Add event listener for show/hide buttons
        toggleInterestButton.addEventListener('click', () => {
            totalInterestPaidContainer.classList.toggle('hidden');
            const expanded = !totalInterestPaidContainer.classList.contains('hidden');
            setInterestIcon(expanded);
        });

        toggleTaCodeButton.addEventListener('click', () => {
            taCodeSection.classList.toggle('hidden');
            const expanded = !taCodeSection.classList.contains('hidden');
            setTaIcon(expanded);
        });
        
        // New event listener for the upgrade button
        upgradeOffer.addEventListener('click', () => {
            const activePlanTile = document.querySelector('.input-tile.active');
            const currentPlan = activePlanTile ? activePlanTile.dataset.plan : null;
            let nextPlan = null;
            if (currentPlan === '3year') {
                nextPlan = '10year';
            } else if (currentPlan === '10year') {
                nextPlan = 'legacy';
            }

            if (nextPlan) {
                const nextPlanTile = document.querySelector(`[data-plan="${nextPlan}"]`);
                if (nextPlanTile) {
                    handlePlanChange(nextPlanTile);
                }
            }
        });

        // New event listener for the interest savings button
        totalInterestSaved.addEventListener('click', () => {
            let currentCashDown = parseFloat(cashDownInput.value) || 0;
            const activePlanTile = document.querySelector('.input-tile.active');
            const plan = activePlanTile ? activePlanTile.dataset.plan : 'legacy';
            const principal = planPrices[plan];
            const newCashDown = Math.min(currentCashDown + 50, principal);
            cashDownInput.value = newCashDown;
            cashDownRange.value = newCashDown;
            calculate();
        });
        
        // Add event listeners for the new tiles
        document.querySelectorAll('[data-plan]').forEach(tile => {
            tile.addEventListener('click', (e) => {
                handlePlanChange(e.currentTarget);
            });
        });

        // Sync number input and range slider for cash down
        cashDownInput.addEventListener('input', () => {
            // Round to nearest 50
            const raw = parseFloat(cashDownInput.value) || 0;
            const rounded = Math.round(raw / 50) * 50;
            cashDownInput.value = rounded;
            cashDownRange.value = rounded;
            calculate();
        });
        cashDownRange.addEventListener('input', () => {
            cashDownInput.value = parseFloat(cashDownRange.value);
            calculate();
        });

        // Amortization range change
        amortizationRange.addEventListener('input', () => {
            const index = parseInt(amortizationRange.value, 10);
            const months = amortizationIndexToMonths(index);
            selectedAmortizationLabel.textContent = `${months} Months`;
            calculate();
        });

        // Add custom keydown event listener to handle the final increment to 100%
        cashDownInput.addEventListener('keydown', (e) => {
            const activePlanTile = document.querySelector('.input-tile.active');
            const planPrice = planPrices[activePlanTile.dataset.plan];
            const taCode = taCodeInput.value;
            const principal = planPrice - TA_CODES[taCode];
            const currentValue = parseFloat(e.target.value) || 0;
            
            if (e.key === 'ArrowUp') {
                // If the next increment would go over the principal, set the value to the principal
                if (currentValue + 50 > principal && currentValue < principal) {
                    e.preventDefault(); // Prevent default up arrow behavior
                    e.target.value = principal;
                    cashDownRange.value = principal;
                    calculate();
                }
            }
        });

        // Add event listeners for the cash down input
        taCodeInput.addEventListener('change', () => {
            // Ensure slider max updates to reflect TA code change
            calculate();
        });
        cashDownInput.addEventListener('blur', calculate);
        cashDownInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                calculate();
            }
        });

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            const initialPlanTile = document.querySelector('[data-plan="legacy"]');
            // Set amortization default to 24 months (index 3 in our mapping)
            amortizationRange.value = terms.indexOf(24);
            selectedAmortizationLabel.textContent = `24 Months`;

            // Initialize toggle icons based on hidden state
            setInterestIcon(!totalInterestPaidContainer.classList.contains('hidden'));
            setTaIcon(!taCodeSection.classList.contains('hidden'));

            if (initialPlanTile) {
                handlePlanChange(initialPlanTile);
            } else {
                calculate();
            }
        });
    </script>
</body>
</html>